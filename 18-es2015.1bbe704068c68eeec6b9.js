(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{wFkS:function(t,e,i){"use strict";i.r(e),i.d(e,"VisitorsListPageModule",(function(){return E}));var s=i("SVse"),o=i("s7LF"),c=i("sZkV"),n=i("iInd"),r=i("z6cu"),a=i("JIr8"),l=i("lJxs"),u=i("vkgz"),h=i("XNiG"),b=i("zx2A");class d{constructor(t,e){this.notifier=t,this.source=e}call(t,e){return e.subscribe(new v(t,this.notifier,this.source))}}class v extends b.b{constructor(t,e,i){super(t),this.notifier=e,this.source=i}error(t){if(!this.isStopped){let i=this.errors,s=this.retries,o=this.retriesSubscription;if(s)this.errors=void 0,this.retriesSubscription=void 0;else{i=new h.a;try{const{notifier:t}=this;s=t(i)}catch(e){return super.error(e)}o=Object(b.c)(s,new b.a(this))}this._unsubscribeAndRecycle(),this.errors=i,this.retries=s,this.retriesSubscription=o,i.next(t)}}_unsubscribe(){const{errors:t,retriesSubscription:e}=this;t&&(t.unsubscribe(),this.errors=void 0),e&&(e.unsubscribe(),this.retriesSubscription=void 0),this.retries=void 0}notifyNext(){const{_unsubscribe:t}=this;this._unsubscribe=null,this._unsubscribeAndRecycle(),this._unsubscribe=t,this.source.subscribe(this)}}var p=i("Kj3r"),g=i("D0XW"),f=i("7o/Q"),_=i("WMd4");class k{constructor(t,e){this.delay=t,this.scheduler=e}call(t,e){return e.subscribe(new m(t,this.delay,this.scheduler))}}class m extends f.a{constructor(t,e,i){super(t),this.delay=e,this.scheduler=i,this.queue=[],this.active=!1,this.errored=!1}static dispatch(t){const e=t.source,i=e.queue,s=t.scheduler,o=t.destination;for(;i.length>0&&i[0].time-s.now()<=0;)i.shift().notification.observe(o);if(i.length>0){const e=Math.max(0,i[0].time-s.now());this.schedule(t,e)}else this.unsubscribe(),e.active=!1}_schedule(t){this.active=!0,this.destination.add(t.schedule(m.dispatch,this.delay,{source:this,destination:this.destination,scheduler:t}))}scheduleNotification(t){if(!0===this.errored)return;const e=this.scheduler,i=new O(e.now()+this.delay,t);this.queue.push(i),!1===this.active&&this._schedule(e)}_next(t){this.scheduleNotification(_.a.createNext(t))}_error(t){this.errored=!0,this.queue=[],this.destination.error(t),this.unsubscribe()}_complete(){this.scheduleNotification(_.a.createComplete()),this.unsubscribe()}}class O{constructor(t,e){this.time=t,this.notification=e}}var C=i("eIep"),y=i("IzEk"),P=i("pLZG"),j=i("nYR2"),w=i("UXun"),A=i("wZ+X"),U=i("8Y7J"),V=i("9Ku7"),I=i("apZm"),S=i("lyr6");function x(t,e){if(1&t&&(U.Pb(0,"ion-text",12),U.sc(1),U.cc(2,"json"),U.Ob()),2&t){const t=U.bc();U.Ab(1),U.uc(" ",U.dc(2,1,t.errors),"\n")}}function D(t,e){if(1&t&&(U.Nb(0),U.Pb(1,"ion-label"),U.Pb(2,"h2"),U.sc(3),U.Ob(),U.Pb(4,"h3"),U.Lb(5,"ion-icon",13),U.sc(6),U.Ob(),U.Ob(),U.Mb()),2&t){const t=e.$implicit;U.Ab(3),U.uc(" ",t.place_name," "),U.Ab(3),U.vc(" ",t.visits_aggregate.aggregate.count," visitor",1===t.visits_aggregate.aggregate.count?"s":""," today ")}}function L(t,e){if(1&t&&(U.Nb(0),U.qc(1,D,7,3,"ng-container",10),U.cc(2,"async"),U.Mb()),2&t){const t=U.bc(2);U.Ab(1),U.hc("ngForOf",U.dc(2,1,t.place))}}function N(t,e){if(1&t&&(U.Pb(0,"ion-list-header"),U.qc(1,L,3,3,"ng-container",9),U.cc(2,"async"),U.Ob()),2&t){const t=U.bc();U.Ab(1),U.hc("ngIf",null!==U.dc(2,1,t.place))}}function q(t,e){if(1&t){const t=U.Qb();U.Pb(0,"ion-item-option",18),U.Xb("click",(function(e){U.nc(t);const i=U.bc().$implicit;return U.bc().clickCheckOut(e,i.visitor.visitor_uuid,i.checked_in_at)})),U.sc(1," Check out "),U.Ob()}}function B(t,e){if(1&t&&(U.Pb(0,"ion-item-sliding"),U.Pb(1,"ion-item-options"),U.qc(2,q,2,0,"ion-item-option",14),U.Ob(),U.Pb(3,"ion-item",15),U.Pb(4,"ion-label",16),U.Pb(5,"span",17),U.sc(6),U.cc(7,"date"),U.cc(8,"date"),U.Ob(),U.Pb(9,"h2"),U.sc(10),U.Ob(),U.Pb(11,"h3"),U.sc(12),U.Ob(),U.Ob(),U.Ob(),U.Ob()),2&t){const t=e.$implicit;U.Ab(2),U.hc("ngIf",!t.checked_out_at),U.Ab(2),U.ic("color",t.checked_out_at?"success":"warning"),U.Ab(2),U.vc(" ",U.ec(7,8,t.checked_in_at,"EEEE HH:mm"),"\u2013",U.ec(8,11,t.checked_out_at,"HH:mm")," "),U.Ab(4),U.vc(" ",t.visitor.visitor_first_name," ",t.visitor.visitor_last_name," "),U.Ab(2),U.vc(" ",t.visitor.visitor_phone," ",t.visitor.visitor_email," ")}}function T(t){const{visitor_first_name:e,visitor_last_name:i,visitor_phone:o,visitor_email:c,checked_in_at:n,checked_out_at:r}=t;return{visitor_first_name:e,visitor_last_name:i,visitor_phone:o,visitor_email:c,checked_in_at:Object(s.q)(n,"HH:mm","en-AU"),checked_out_at:Object(s.q)(r,"HH:mm","en-AU")}}const H=[{path:"",component:(()=>{class t{constructor(t,e,i,s,o,c){this.activatedRoute=t,this.router=e,this.toastController=i,this.authenticationService=s,this.checkInOutService=o,this.placeAdminService=c,this.missionControlCoverClickedUnlocked=!1,this.errors=[],this.placeUUID=t.snapshot.paramMap.get("placeUUID"),console.log("VisitorsListPage -> constructor -> this.placeUUID",this.placeUUID);const n=c.getVisitorsByPlaceUUID(this.placeUUID);this.placeVisitorsResult=n;const h=n.pipe(Object(a.a)((t,e)=>{var i;console.error("VisitorsListPage -> err",t),console.error("VisitorsListPage -> caught",e);const s=t;console.error("VisitorsListPage -> apolloError",s);const o=null===(i=s.extensions)||void 0===i?void 0:i.code;return this.presentToast(`Real-time subscription out of sync. Authorisation expired; Please try refreshing or signing in again to administrate your COVIDSafe registry. <br/> ${o}<br/> Reloading soon`),Object(r.a)(t)}),Object(l.a)(t=>(console.log("VisitorsListPage -> interceptResult",t),t)),Object(u.a)(t=>{console.log("VisitorsListPage -> placeVisitorsResult",t)}),(b=t=>(console.log("VisitorsListPage -> retryWhen errors",t),t.pipe(Object(p.a)(500),function(t,e=g.a){var i;const s=(i=t)instanceof Date&&!isNaN(+i)?+t-e.now():Math.abs(t);return t=>t.lift(new k(s,e))}(5e3),Object(u.a)(t=>{console.log("VisitorsListPage -> triggerSideEffectBigRefresh",t),location.reload()}),Object(C.a)(t=>c.getVisitorsByPlaceUUID(this.placeUUID)),Object(y.a)(1),Object(u.a)(t=>{}))),t=>t.lift(new d(b,t))),Object(u.a)(t=>{var e;0===(null===(e=t.data)||void 0===e?void 0:e.place.length)&&(this.presentToast("No places found. Have you activated the correct Place link? <br/>Check account setup or email info@singletouchdigital.com.au to find out more"),this.router.navigate(["sign-in"]))}),Object(P.a)(t=>{var e,i;return void 0!==(null===(i=null===(e=t.data)||void 0===e?void 0:e.place)||void 0===i?void 0:i[0])}),Object(l.a)(t=>t.data.place),Object(u.a)(t=>{console.log("VisitorsListPage -> greatSuccess",t),this.placeSyncDetail=null==t?void 0:t[0]}),Object(j.a)(()=>{console.log("VisitorsListPage -> completed")}));var b;this.place=h;const v=h.pipe(Object(l.a)(t=>t[0].visits),Object(w.a)(1));this.visits=v,this.visitsPendingCheckOut=this.visits.pipe(Object(l.a)(t=>t.filter(t=>Object(A.c)(t.checked_out_at)))),this.countVisitsPendingCheckOut=this.visitsPendingCheckOut.pipe(Object(l.a)(({length:t})=>t),Object(w.a)(1))}ngOnInit(){}clickCheckOut(t,e,i){if(console.log("clickCheckOut -> event",t),void 0===e||void 0===i)return;const s=this.checkInOutService.updateCheckOutVisitor(this.placeUUID,e,i);console.log("VisitorsListPage -> clickCheckOut -> checkedOutObs",s),s.subscribe(({data:t,errors:e,context:i,extensions:s})=>{var o;console.log("clickCheckOut -> data",t,e,i,s);const c=new Date(null===(o=null==t?void 0:t.update_visit_by_pk)||void 0===o?void 0:o.checked_out_at);console.log("VisitorsListPage -> clickCheckOut -> checkedOutDateTime",c)})}getCountPendingCheckoutVisitors(){}filterRemainingPendingCheckOutVisitors(){}clickMissionControlNonBlockingSwitchNotificationToastFade(){this.countVisitsPendingCheckOut.pipe(Object(y.a)(1)).subscribe(t=>{this.missionControlCoverClickedUnlocked=!this.missionControlCoverClickedUnlocked,this.missionControlCoverClickedUnlocked&&this.presentToast(`Are you sure you want to export and check out remaining ${t} visitors?<br/>(for end of day reconciliation)`,800,"passiveToast")})}clickBulkCheckOut(t,e){this.placeAdminService.updateBulkCheckOut(e).pipe(Object(u.a)(t=>{console.log("bulkCheckOut",t)}),Object(P.a)(t=>{var e,i,s,o;return null!==(null===(i=null===(e=t.data)||void 0===e?void 0:e.update_visit)||void 0===i?void 0:i.affected_rows)&&void 0!==(null===(o=null===(s=t.data)||void 0===s?void 0:s.update_visit)||void 0===o?void 0:o.affected_rows)}),Object(y.a)(1),Object(l.a)(t=>t.data.update_visit),Object(u.a)(t=>{const e=t.affected_rows>0?`Thank you for keeping us a COVIDSafe Place<br/>Successfully checked out ${t.affected_rows} visitors`:"Thank you for keeping us a COVIDSafe Place<br/>Visitors already checked out";console.log("clickBulkCheckOut -> successfulEndOfDayBulkCheckOut",t,e),this.presentToast(e)}),Object(C.a)(t=>this.visits),Object(l.a)(t=>t.map(({visitor:{visitor_first_name:t,visitor_last_name:e,visitor_phone:i,visitor_email:s},checked_in_at:o,checked_out_at:c})=>({visitor_first_name:t,visitor_last_name:e,visitor_phone:i,visitor_email:s,checked_in_at:o,checked_out_at:c}))),Object(u.a)(t=>{this.downloadExportVisitorList(t)})).subscribe()}downloadExportVisitorList(t){var e;const i=function(t=""){return""===t||Object(A.c)(t)?"":t.replace(/[/\\?%*:|"<> ]/g,"-")}(null===(e=this.placeSyncDetail)||void 0===e?void 0:e.place_name);!function(t,e,i="list"){const o=function(t,e){const i="object"!=typeof t?JSON.parse(t):t;let s="",o="row_number,";for(let c in e)o+=e[c]+",";o=o.slice(0,-1),s+=o+"\r\n";for(let c=0;c<i.length;c++){let t=`"${c+1}"`;for(let s in e){const o=i[c][e[s]].replace(/"/g,'\\"'),n="0";t+=","+(o.charAt(0)===n?`="${o}"`:`"${o}"`)}s+=t+"\r\n"}return s}(t,["visitor_first_name","visitor_last_name","visitor_phone","visitor_email","checked_in_at","checked_out_at"]),c=function(t){const e=new Date;return`${t}-${Object(s.q)(e,"yyyyMMdd'-'HHmmss'-UTC'ZZZ","en-AU")}`}(i);console.log("downloadJsonToCsvFile() -> timestampedFileName",c);const n=new Blob(["\ufeff"+o],{type:"text/csv;charset=utf-8;"});navigator.msSaveBlob&&navigator.msSaveBlob(n,c);const r=document.createElement("a"),a=URL.createObjectURL(n);-1!==navigator.userAgent.indexOf("Safari")&&-1===navigator.userAgent.indexOf("Chrome")&&r.setAttribute("target","_blank"),r.setAttribute("href",a),r.setAttribute("download",c+".csv"),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r)}(t.map(T),0,"covidsafeplace-visitor-list-"+i)}presentToast(t="loading",e=3500,i,s){this.toastController.create({message:t,duration:e,animated:!0,cssClass:i,color:s,translucent:!0}).then(t=>t.present()).then(()=>{console.log("Toast presented "+t)})}}return t.\u0275fac=function(e){return new(e||t)(U.Kb(n.a),U.Kb(n.g),U.Kb(c.J),U.Kb(V.a),U.Kb(I.a),U.Kb(S.a))},t.\u0275cmp=U.Eb({type:t,selectors:[["app-visitors-list"]],decls:23,vars:15,consts:[["color","cobaltblue"],["color","danger",4,"ngIf"],["horizontal","start","vertical","bottom","slot","fixed","size","large"],["color","cobaltbluemonochrome",3,"click"],["name","list-outline","size","large"],["name","log-out-outline","size","small"],["side","end"],["color","warning"],["name","log-out-outline","color","","size","large",3,"click"],[4,"ngIf"],[4,"ngFor","ngForOf"],["color","light","hidden",""],["color","danger"],["name","people"],["color","success","button","",3,"click",4,"ngIf"],["button",""],[3,"color"],[2,"float","right"],["color","success","button","",3,"click"]],template:function(t,e){1&t&&(U.Pb(0,"ion-header"),U.Pb(1,"ion-toolbar",0),U.Pb(2,"ion-title"),U.sc(3," List COVIDSafe check ins \u2705 | Place visitors "),U.Ob(),U.Ob(),U.Ob(),U.qc(4,x,3,3,"ion-text",1),U.Pb(5,"ion-fab",2),U.Pb(6,"ion-fab-button",3),U.Xb("click",(function(){return e.clickMissionControlNonBlockingSwitchNotificationToastFade()})),U.Lb(7,"ion-icon",4),U.Lb(8,"ion-icon",5),U.Ob(),U.Pb(9,"ion-fab-list",6),U.Pb(10,"ion-fab-button",7),U.Pb(11,"ion-icon",8),U.Xb("click",(function(t){return e.clickBulkCheckOut(t,e.placeUUID)})),U.Ob(),U.Ob(),U.Ob(),U.Ob(),U.Pb(12,"ion-content"),U.Pb(13,"ion-list"),U.qc(14,N,3,3,"ion-list-header",9),U.qc(15,B,13,14,"ion-item-sliding",10),U.cc(16,"async"),U.Ob(),U.Pb(17,"ion-text",11),U.sc(18),U.cc(19,"json"),U.cc(20,"async"),U.cc(21,"json"),U.cc(22,"async"),U.Ob(),U.Ob()),2&t&&(U.Ab(4),U.hc("ngIf",e.errors.length>0),U.Ab(10),U.hc("ngIf",e.place),U.Ab(1),U.hc("ngForOf",U.dc(16,5,e.visits)),U.Ab(3),U.vc(" 1 ",U.dc(19,7,U.dc(20,9,e.place))," 2 ",U.dc(21,11,U.dc(22,13,e.visits))," "))},directives:[c.n,c.C,c.B,s.m,c.j,c.k,c.o,c.l,c.i,c.w,s.l,c.A,c.x,c.v,c.u,c.t,c.q,c.s],pipes:[s.b,s.g,s.e],styles:["ion-icon[_ngcontent-%COMP%]{vertical-align:middle}"]}),t})()}];let R=(()=>{class t{}return t.\u0275mod=U.Ib({type:t}),t.\u0275inj=U.Hb({factory:function(e){return new(e||t)},imports:[[n.i.forChild(H)],n.i]}),t})(),E=(()=>{class t{}return t.\u0275mod=U.Ib({type:t}),t.\u0275inj=U.Hb({factory:function(e){return new(e||t)},imports:[[s.c,o.g,c.D,R]]}),t})()}}]);