!function(){function t(e,i,n){return(t="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var n=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=c(t)););return t}(t,e);if(n){var o=Object.getOwnPropertyDescriptor(n,e);return o.get?o.get.call(i):o.value}})(e,i,n||e)}function e(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&i(t,e)}function i(t,e){return(i=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function n(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var i,n=c(t);if(e){var r=c(this).constructor;i=Reflect.construct(n,arguments,r)}else i=n.apply(this,arguments);return o(this,i)}}function o(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function c(t){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function a(t,e,i){return e&&s(t.prototype,e),i&&s(t,i),t}(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{wFkS:function(i,o,s){"use strict";s.r(o),s.d(o,"VisitorsListPageModule",(function(){return $}));var u=s("SVse"),l=s("s7LF"),f=s("sZkV"),h=s("iInd"),b=s("z6cu"),d=s("JIr8"),v=s("lJxs"),p=s("vkgz"),g=s("XNiG"),k=s("zx2A"),O=function(){function t(e,i){r(this,t),this.notifier=e,this.source=i}return a(t,[{key:"call",value:function(t,e){return e.subscribe(new _(t,this.notifier,this.source))}}]),t}(),_=function(i){e(s,i);var o=n(s);function s(t,e,i){var n;return r(this,s),(n=o.call(this,t)).notifier=e,n.source=i,n}return a(s,[{key:"error",value:function(e){if(!this.isStopped){var i=this.errors,n=this.retries,o=this.retriesSubscription;if(n)this.errors=void 0,this.retriesSubscription=void 0;else{i=new g.a;try{n=(0,this.notifier)(i)}catch(r){return t(c(s.prototype),"error",this).call(this,r)}o=Object(k.c)(n,new k.a(this))}this._unsubscribeAndRecycle(),this.errors=i,this.retries=n,this.retriesSubscription=o,i.next(e)}}},{key:"_unsubscribe",value:function(){var t=this.errors,e=this.retriesSubscription;t&&(t.unsubscribe(),this.errors=void 0),e&&(e.unsubscribe(),this.retriesSubscription=void 0),this.retries=void 0}},{key:"notifyNext",value:function(){var t=this._unsubscribe;this._unsubscribe=null,this._unsubscribeAndRecycle(),this._unsubscribe=t,this.source.subscribe(this)}}]),s}(k.b),m=s("Kj3r"),y=s("D0XW"),P=s("7o/Q"),C=s("WMd4"),j=function(){function t(e,i){r(this,t),this.delay=e,this.scheduler=i}return a(t,[{key:"call",value:function(t,e){return e.subscribe(new w(t,this.delay,this.scheduler))}}]),t}(),w=function(t){e(o,t);var i=n(o);function o(t,e,n){var c;return r(this,o),(c=i.call(this,t)).delay=e,c.scheduler=n,c.queue=[],c.active=!1,c.errored=!1,c}return a(o,[{key:"_schedule",value:function(t){this.active=!0,this.destination.add(t.schedule(o.dispatch,this.delay,{source:this,destination:this.destination,scheduler:t}))}},{key:"scheduleNotification",value:function(t){if(!0!==this.errored){var e=this.scheduler,i=new A(e.now()+this.delay,t);this.queue.push(i),!1===this.active&&this._schedule(e)}}},{key:"_next",value:function(t){this.scheduleNotification(C.a.createNext(t))}},{key:"_error",value:function(t){this.errored=!0,this.queue=[],this.destination.error(t),this.unsubscribe()}},{key:"_complete",value:function(){this.scheduleNotification(C.a.createComplete()),this.unsubscribe()}}],[{key:"dispatch",value:function(t){for(var e=t.source,i=e.queue,n=t.scheduler,o=t.destination;i.length>0&&i[0].time-n.now()<=0;)i.shift().notification.observe(o);if(i.length>0){var c=Math.max(0,i[0].time-n.now());this.schedule(t,c)}else this.unsubscribe(),e.active=!1}}]),o}(P.a),A=function t(e,i){r(this,t),this.time=e,this.notification=i},U=s("eIep"),V=s("IzEk"),I=s("pLZG"),S=s("nYR2"),D=s("UXun"),x=s("wZ+X"),L=s("8Y7J"),R=s("9Ku7"),N=s("apZm"),T=s("lyr6");function E(t,e){if(1&t&&(L.Pb(0,"ion-text",12),L.sc(1),L.cc(2,"json"),L.Ob()),2&t){var i=L.bc();L.Ab(1),L.uc(" ",L.dc(2,1,i.errors),"\n")}}function q(t,e){if(1&t&&(L.Nb(0),L.Pb(1,"ion-label"),L.Pb(2,"h2"),L.sc(3),L.Ob(),L.Pb(4,"h3"),L.Lb(5,"ion-icon",13),L.sc(6),L.Ob(),L.Ob(),L.Mb()),2&t){var i=e.$implicit;L.Ab(3),L.uc(" ",i.place_name," "),L.Ab(3),L.vc(" ",i.visits_aggregate.aggregate.count," visitor",1===i.visits_aggregate.aggregate.count?"s":""," today ")}}function B(t,e){if(1&t&&(L.Nb(0),L.qc(1,q,7,3,"ng-container",10),L.cc(2,"async"),L.Mb()),2&t){var i=L.bc(2);L.Ab(1),L.hc("ngForOf",L.dc(2,1,i.place))}}function H(t,e){if(1&t&&(L.Pb(0,"ion-list-header"),L.qc(1,B,3,3,"ng-container",9),L.cc(2,"async"),L.Ob()),2&t){var i=L.bc();L.Ab(1),L.hc("ngIf",null!==L.dc(2,1,i.place))}}function M(t,e){if(1&t){var i=L.Qb();L.Pb(0,"ion-item-option",18),L.Xb("click",(function(t){L.nc(i);var e=L.bc().$implicit;return L.bc().clickCheckOut(t,e.visitor.visitor_uuid,e.checked_in_at)})),L.sc(1," Check out "),L.Ob()}}function F(t,e){if(1&t&&(L.Pb(0,"ion-item-sliding"),L.Pb(1,"ion-item-options"),L.qc(2,M,2,0,"ion-item-option",14),L.Ob(),L.Pb(3,"ion-item",15),L.Pb(4,"ion-label",16),L.Pb(5,"span",17),L.sc(6),L.cc(7,"date"),L.cc(8,"date"),L.Ob(),L.Pb(9,"h2"),L.sc(10),L.Ob(),L.Pb(11,"h3"),L.sc(12),L.Ob(),L.Ob(),L.Ob(),L.Ob()),2&t){var i=e.$implicit;L.Ab(2),L.hc("ngIf",!i.checked_out_at),L.Ab(2),L.ic("color",i.checked_out_at?"success":"warning"),L.Ab(2),L.vc(" ",L.ec(7,8,i.checked_in_at,"EEEE HH:mm"),"\u2013",L.ec(8,11,i.checked_out_at,"HH:mm")," "),L.Ab(4),L.vc(" ",i.visitor.visitor_first_name," ",i.visitor.visitor_last_name," "),L.Ab(2),L.vc(" ",i.visitor.visitor_phone," ",i.visitor.visitor_email," ")}}function z(t){var e=t.visitor_first_name,i=t.visitor_last_name,n=t.visitor_phone,o=t.visitor_email,c=t.checked_in_at,r=t.checked_out_at;return{visitor_first_name:e,visitor_last_name:i,visitor_phone:n,visitor_email:o,checked_in_at:Object(u.q)(c,"HH:mm","en-AU"),checked_out_at:Object(u.q)(r,"HH:mm","en-AU")}}var J,K,X,Z=[{path:"",component:(J=function(){function t(e,i,n,o,c,s){var a=this;r(this,t),this.activatedRoute=e,this.router=i,this.toastController=n,this.authenticationService=o,this.checkInOutService=c,this.placeAdminService=s,this.missionControlCoverClickedUnlocked=!1,this.errors=[],this.placeUUID=e.snapshot.paramMap.get("placeUUID"),console.log("VisitorsListPage -> constructor -> this.placeUUID",this.placeUUID);var u=s.getVisitorsByPlaceUUID(this.placeUUID);this.placeVisitorsResult=u;var l,f=u.pipe(Object(d.a)((function(t,e){var i;console.error("VisitorsListPage -> err",t),console.error("VisitorsListPage -> caught",e);var n=t;console.error("VisitorsListPage -> apolloError",n);var o=null===(i=n.extensions)||void 0===i?void 0:i.code;return a.presentToast("Real-time subscription out of sync. Authorisation expired; Please try refreshing or signing in again to administrate your COVIDSafe registry. <br/> ".concat(o,"<br/> Reloading soon")),Object(b.a)(t)})),Object(v.a)((function(t){return console.log("VisitorsListPage -> interceptResult",t),t})),Object(p.a)((function(t){console.log("VisitorsListPage -> placeVisitorsResult",t)})),(l=function(t){return console.log("VisitorsListPage -> retryWhen errors",t),t.pipe(Object(m.a)(500),function(t){var e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:y.a,n=(e=t)instanceof Date&&!isNaN(+e)?+t-i.now():Math.abs(t);return function(t){return t.lift(new j(n,i))}}(5e3),Object(p.a)((function(t){console.log("VisitorsListPage -> triggerSideEffectBigRefresh",t),location.reload()})),Object(U.a)((function(t){return s.getVisitorsByPlaceUUID(a.placeUUID)})),Object(V.a)(1),Object(p.a)((function(t){})))},function(t){return t.lift(new O(l,t))}),Object(p.a)((function(t){var e;0===(null===(e=t.data)||void 0===e?void 0:e.place.length)&&(a.presentToast("No places found. Have you activated the correct Place link? <br/>Check account setup or email info@singletouchdigital.com.au to find out more"),a.router.navigate(["sign-in"]))})),Object(I.a)((function(t){var e,i;return void 0!==(null===(i=null===(e=t.data)||void 0===e?void 0:e.place)||void 0===i?void 0:i[0])})),Object(v.a)((function(t){return t.data.place})),Object(p.a)((function(t){console.log("VisitorsListPage -> greatSuccess",t),a.placeSyncDetail=null==t?void 0:t[0]})),Object(S.a)((function(){console.log("VisitorsListPage -> completed")})));this.place=f;var h=f.pipe(Object(v.a)((function(t){return t[0].visits})),Object(D.a)(1));this.visits=h,this.visitsPendingCheckOut=this.visits.pipe(Object(v.a)((function(t){return t.filter((function(t){return Object(x.c)(t.checked_out_at)}))}))),this.countVisitsPendingCheckOut=this.visitsPendingCheckOut.pipe(Object(v.a)((function(t){return t.length})),Object(D.a)(1))}return a(t,[{key:"ngOnInit",value:function(){}},{key:"clickCheckOut",value:function(t,e,i){if(console.log("clickCheckOut -> event",t),void 0!==e&&void 0!==i){var n=this.checkInOutService.updateCheckOutVisitor(this.placeUUID,e,i);console.log("VisitorsListPage -> clickCheckOut -> checkedOutObs",n),n.subscribe((function(t){var e,i=t.data,n=t.errors,o=t.context,c=t.extensions;console.log("clickCheckOut -> data",i,n,o,c);var r=new Date(null===(e=null==i?void 0:i.update_visit_by_pk)||void 0===e?void 0:e.checked_out_at);console.log("VisitorsListPage -> clickCheckOut -> checkedOutDateTime",r)}))}}},{key:"getCountPendingCheckoutVisitors",value:function(){}},{key:"filterRemainingPendingCheckOutVisitors",value:function(){}},{key:"clickMissionControlNonBlockingSwitchNotificationToastFade",value:function(){var t=this;this.countVisitsPendingCheckOut.pipe(Object(V.a)(1)).subscribe((function(e){t.missionControlCoverClickedUnlocked=!t.missionControlCoverClickedUnlocked,t.missionControlCoverClickedUnlocked&&t.presentToast("Are you sure you want to export and check out remaining ".concat(e," visitors?<br/>(for end of day reconciliation)"),800,"passiveToast")}))}},{key:"clickBulkCheckOut",value:function(t,e){var i=this;this.placeAdminService.updateBulkCheckOut(e).pipe(Object(p.a)((function(t){console.log("bulkCheckOut",t)})),Object(I.a)((function(t){var e,i,n,o;return null!==(null===(i=null===(e=t.data)||void 0===e?void 0:e.update_visit)||void 0===i?void 0:i.affected_rows)&&void 0!==(null===(o=null===(n=t.data)||void 0===n?void 0:n.update_visit)||void 0===o?void 0:o.affected_rows)})),Object(V.a)(1),Object(v.a)((function(t){return t.data.update_visit})),Object(p.a)((function(t){var e=t.affected_rows>0?"Thank you for keeping us a COVIDSafe Place<br/>Successfully checked out ".concat(t.affected_rows," visitors"):"Thank you for keeping us a COVIDSafe Place<br/>Visitors already checked out";console.log("clickBulkCheckOut -> successfulEndOfDayBulkCheckOut",t,e),i.presentToast(e)})),Object(U.a)((function(t){return i.visits})),Object(v.a)((function(t){return t.map((function(t){var e=t.visitor;return{visitor_first_name:e.visitor_first_name,visitor_last_name:e.visitor_last_name,visitor_phone:e.visitor_phone,visitor_email:e.visitor_email,checked_in_at:t.checked_in_at,checked_out_at:t.checked_out_at}}))})),Object(p.a)((function(t){i.downloadExportVisitorList(t)}))).subscribe()}},{key:"downloadExportVisitorList",value:function(t){var e,i=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return""===t||Object(x.c)(t)?"":t.replace(/[/\\?%*:|"<> ]/g,"-")}(null===(e=this.placeSyncDetail)||void 0===e?void 0:e.place_name);!function(t,e){var i,n,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"list",c=function(t,e){var i="object"!=typeof t?JSON.parse(t):t,n="",o="row_number,";for(var c in e)o+=e[c]+",";n+=(o=o.slice(0,-1))+"\r\n";for(var r=0;r<i.length;r++){var s='"'.concat(r+1,'"');for(var a in e){var u=i[r][e[a]].replace(/"/g,'\\"');s+=","+("0"===u.charAt(0)?'="'.concat(u,'"'):'"'.concat(u,'"'))}n+=s+"\r\n"}return n}(t,["visitor_first_name","visitor_last_name","visitor_phone","visitor_email","checked_in_at","checked_out_at"]),r=(i=o,n=new Date,"".concat(i,"-").concat(Object(u.q)(n,"yyyyMMdd'-'HHmmss'-UTC'ZZZ","en-AU")));console.log("downloadJsonToCsvFile() -> timestampedFileName",r);var s=new Blob(["\ufeff"+c],{type:"text/csv;charset=utf-8;"});navigator.msSaveBlob&&navigator.msSaveBlob(s,r);var a=document.createElement("a"),l=URL.createObjectURL(s);-1!==navigator.userAgent.indexOf("Safari")&&-1===navigator.userAgent.indexOf("Chrome")&&a.setAttribute("target","_blank"),a.setAttribute("href",l),a.setAttribute("download",r+".csv"),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)}(t.map(z),0,"covidsafeplace-visitor-list-"+i)}},{key:"presentToast",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"loading",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3500,i=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0;this.toastController.create({message:t,duration:e,animated:!0,cssClass:i,color:n,translucent:!0}).then((function(t){return t.present()})).then((function(){console.log("Toast presented "+t)}))}}]),t}(),J.\u0275fac=function(t){return new(t||J)(L.Kb(h.a),L.Kb(h.g),L.Kb(f.J),L.Kb(R.a),L.Kb(N.a),L.Kb(T.a))},J.\u0275cmp=L.Eb({type:J,selectors:[["app-visitors-list"]],decls:23,vars:15,consts:[["color","cobaltblue"],["color","danger",4,"ngIf"],["horizontal","start","vertical","bottom","slot","fixed","size","large"],["color","cobaltbluemonochrome",3,"click"],["name","list-outline","size","large"],["name","log-out-outline","size","small"],["side","end"],["color","warning"],["name","log-out-outline","color","","size","large",3,"click"],[4,"ngIf"],[4,"ngFor","ngForOf"],["color","light","hidden",""],["color","danger"],["name","people"],["color","success","button","",3,"click",4,"ngIf"],["button",""],[3,"color"],[2,"float","right"],["color","success","button","",3,"click"]],template:function(t,e){1&t&&(L.Pb(0,"ion-header"),L.Pb(1,"ion-toolbar",0),L.Pb(2,"ion-title"),L.sc(3," List COVIDSafe check ins \u2705 | Place visitors "),L.Ob(),L.Ob(),L.Ob(),L.qc(4,E,3,3,"ion-text",1),L.Pb(5,"ion-fab",2),L.Pb(6,"ion-fab-button",3),L.Xb("click",(function(){return e.clickMissionControlNonBlockingSwitchNotificationToastFade()})),L.Lb(7,"ion-icon",4),L.Lb(8,"ion-icon",5),L.Ob(),L.Pb(9,"ion-fab-list",6),L.Pb(10,"ion-fab-button",7),L.Pb(11,"ion-icon",8),L.Xb("click",(function(t){return e.clickBulkCheckOut(t,e.placeUUID)})),L.Ob(),L.Ob(),L.Ob(),L.Ob(),L.Pb(12,"ion-content"),L.Pb(13,"ion-list"),L.qc(14,H,3,3,"ion-list-header",9),L.qc(15,F,13,14,"ion-item-sliding",10),L.cc(16,"async"),L.Ob(),L.Pb(17,"ion-text",11),L.sc(18),L.cc(19,"json"),L.cc(20,"async"),L.cc(21,"json"),L.cc(22,"async"),L.Ob(),L.Ob()),2&t&&(L.Ab(4),L.hc("ngIf",e.errors.length>0),L.Ab(10),L.hc("ngIf",e.place),L.Ab(1),L.hc("ngForOf",L.dc(16,5,e.visits)),L.Ab(3),L.vc(" 1 ",L.dc(19,7,L.dc(20,9,e.place))," 2 ",L.dc(21,11,L.dc(22,13,e.visits))," "))},directives:[f.n,f.C,f.B,u.m,f.j,f.k,f.o,f.l,f.i,f.w,u.l,f.A,f.x,f.v,f.u,f.t,f.q,f.s],pipes:[u.b,u.g,u.e],styles:["ion-icon[_ngcontent-%COMP%]{vertical-align:middle}"]}),J)}],W=((X=function t(){r(this,t)}).\u0275mod=L.Ib({type:X}),X.\u0275inj=L.Hb({factory:function(t){return new(t||X)},imports:[[h.i.forChild(Z)],h.i]}),X),$=((K=function t(){r(this,t)}).\u0275mod=L.Ib({type:K}),K.\u0275inj=L.Hb({factory:function(t){return new(t||K)},imports:[[u.c,l.g,f.D,W]]}),K)}}])}();